from flask import Flask, request, jsonify
from flask_cors import CORS
import google.generativeai as genai
import os
import json
from datetime import datetime

app = Flask(__name__)
CORS(app)

# Configure Gemini API
GEMINI_API_KEY = os.environ.get('GEMINI_API_KEY')
if not GEMINI_API_KEY:
    raise ValueError("GEMINI_API_KEY environment variable not set")

genai.configure(api_key=GEMINI_API_KEY)

# Tone-specific prompts
TONE_PROMPTS = {
    'original': 'Maintain the original tone and style while correcting grammar, spelling, and punctuation errors.',
    'professional': 'Transform the text into a professional, business-appropriate tone while correcting errors.',
    'casual': 'Make the text more casual and conversational while fixing grammar and spelling mistakes.',
    'academic': 'Convert the text to an academic, formal style with proper grammar and scholarly language.',
    'creative': 'Enhance the text with creative flair and vivid language while maintaining clarity.'
}

def create_enhancement_prompt(text, tone, show_explanations):
    base_prompt = f"""You are an expert writing assistant. Your task is to enhance the following text.

Tone: {tone.upper()}
Instructions: {TONE_PROMPTS.get(tone, TONE_PROMPTS['original'])}

Original text:
{text}

"""
    
    if show_explanations:
        base_prompt += """
Provide your response in the following JSON format:
{
    "correctedText": "The fully corrected and enhanced text",
    "improvements": [
        {
            "original": "original problematic phrase",
            "fixed": "corrected phrase",
            "reason": "brief explanation of the change"
        }
    ]
}

Include up to 5 most significant improvements.
"""
    else:
        base_prompt += """
Provide your response in the following JSON format:
{
    "correctedText": "The fully corrected and enhanced text"
}
"""
    
    return base_prompt

@app.route('/api/enhance', methods=['POST'])
def enhance_text():
    try:
        data = request.get_json()
        
        if not data or 'text' not in data:
            return jsonify({'error': 'No text provided'}), 400
        
        text = data['text']
        tone = data.get('tone', 'original')
        show_explanations = data.get('showExplanations', True)
        
        if not text.strip():
            return jsonify({'error': 'Text cannot be empty'}), 400
        
        # Create the prompt
        prompt = create_enhancement_prompt(text, tone, show_explanations)
        
        # Call Gemini API
        model = genai.GenerativeModel('gemini-2.0-flash-exp')
        response = model.generate_content(prompt)
        
        # Parse the response
        response_text = response.text.strip()
        
        # Remove markdown code blocks if present
        if response_text.startswith('```json'):
            response_text = response_text[7:]
        if response_text.startswith('```'):
            response_text = response_text[3:]
        if response_text.endswith('```'):
            response_text = response_text[:-3]
        
        response_text = response_text.strip()
        
        # Parse JSON
        result = json.loads(response_text)
        
        return jsonify(result), 200
        
    except json.JSONDecodeError as e:
        return jsonify({'error': f'Failed to parse AI response: {str(e)}'}), 500
    except Exception as e:
        return jsonify({'error': f'Error processing request: {str(e)}'}), 500

@app.route('/api/health', methods=['GET'])
def health_check():
    return jsonify({
        'status': 'healthy',
        'timestamp': datetime.now().isoformat(),
        'version': '1.0.0'
    }), 200

@app.route('/api/tones', methods=['GET'])
def get_tones():
    return jsonify({
        'tones': list(TONE_PROMPTS.keys())
    }), 200

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)
